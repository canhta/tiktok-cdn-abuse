{% extends "base.html" %}

{% block title %}Video Player - {{ video_id }}{% endblock %}

{% block head %}
<script src="/static/libs/hls.min.js"></script>
{% endblock %}

{% block content %}
<div class="mb-6">
    <div class="flex items-center gap-4 mb-4">
        <a href="/videos" class="btn btn-secondary">â† Back to Videos</a>
        <div>
            <h1 class="page-title">â–¶ï¸ Video Player</h1>
            <p class="page-subtitle">Video ID: {{ video_id }}</p>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Video Player -->
    <div class="lg:col-span-2">
        <div class="card">
            <div class="card-content p-0">
                <div class="video-container">
                    <video id="videoPlayer" class="video-player" controls>
                        <p>Your browser does not support HLS video playback.</p>
                    </video>
                </div>
            </div>
        </div>
        
        <!-- Player Controls -->
        <div class="card mt-4">
            <div class="card-header">
                <h3 class="card-title">ğŸ® Player Controls</h3>
            </div>
            <div class="card-content">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                    <button onclick="playPause()" class="btn btn-primary" id="playPauseBtn">
                        â–¶ï¸ Play
                    </button>
                    <button onclick="seekBackward()" class="btn btn-secondary">
                        âª -10s
                    </button>
                    <button onclick="seekForward()" class="btn btn-secondary">
                        â© +10s
                    </button>
                    <button onclick="toggleFullscreen()" class="btn btn-secondary">
                        ğŸ”² Fullscreen
                    </button>
                </div>
                
                <div class="mt-4">
                    <label class="form-label">Volume</label>
                    <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="1" 
                           class="w-full" onchange="setVolume(this.value)">
                </div>
                
                <div class="mt-4">
                    <label class="form-label">Playback Speed</label>
                    <select id="speedSelect" class="form-select" onchange="setPlaybackRate(this.value)">
                        <option value="0.5">0.5x</option>
                        <option value="0.75">0.75x</option>
                        <option value="1" selected>1x</option>
                        <option value="1.25">1.25x</option>
                        <option value="1.5">1.5x</option>
                        <option value="2">2x</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Video Info & Actions -->
    <div class="lg:col-span-1">
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title">ğŸ“‹ Video Information</h3>
            </div>
            <div class="card-content">
                <div class="space-y-3 text-sm">
                    <div>
                        <strong>Video ID:</strong><br>
                        <code class="bg-gray-100 px-2 py-1 rounded">{{ video_id }}</code>
                    </div>
                    <div>
                        <strong>Playlist URL:</strong><br>
                        <a href="/playlist/{{ video_id }}" target="_blank" class="text-primary">
                            /playlist/{{ video_id }}
                        </a>
                    </div>
                    <div>
                        <strong>Status:</strong><br>
                        <span id="playerStatus" class="text-secondary">Loading...</span>
                    </div>
                    <div>
                        <strong>Duration:</strong><br>
                        <span id="videoDuration">--:--</span>
                    </div>
                    <div>
                        <strong>Current Time:</strong><br>
                        <span id="currentTime">--:--</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title">ğŸ”— Share & Export</h3>
            </div>
            <div class="card-content">
                <div class="space-y-2">
                    <button onclick="copyPlaylistUrl()" class="btn btn-secondary w-full">
                        ğŸ“‹ Copy Playlist URL
                    </button>
                    <button onclick="copyPlayerUrl()" class="btn btn-secondary w-full">
                        ğŸ”— Copy Player URL
                    </button>
                    <button onclick="downloadPlaylist()" class="btn btn-secondary w-full">
                        ğŸ’¾ Download M3U8
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title">ğŸ“Š Playback Stats</h3>
            </div>
            <div class="card-content">
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span>Quality:</span>
                        <span id="videoQuality">Auto</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Buffer Health:</span>
                        <span id="bufferHealth">--</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Dropped Frames:</span>
                        <span id="droppedFrames">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Network State:</span>
                        <span id="networkState">--</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">âš™ï¸ Actions</h3>
            </div>
            <div class="card-content">
                <div class="space-y-2">
                    <button onclick="reloadVideo()" class="btn btn-warning w-full">
                        ğŸ”„ Reload Video
                    </button>
                    <button onclick="showPlaylistInfo()" class="btn btn-secondary w-full">
                        ğŸ“„ Show Playlist Info
                    </button>
                    <button onclick="deleteVideo()" class="btn btn-error w-full">
                        ğŸ—‘ï¸ Delete Video
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Playlist Info Modal -->
<div id="playlistModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ“„ Playlist Information</h3>
            <button onclick="closePlaylistModal()" class="btn btn-secondary btn-sm">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="mb-4">
                <label class="form-label">M3U8 Content:</label>
                <textarea id="playlistContent" class="form-textarea" rows="10" readonly></textarea>
            </div>
            <div class="flex gap-2">
                <button onclick="copyPlaylistContent()" class="btn btn-secondary">ğŸ“‹ Copy</button>
                <button onclick="downloadPlaylistFile()" class="btn btn-secondary">ğŸ’¾ Download</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let hls;
let video;
let videoId = '{{ video_id }}';

document.addEventListener('DOMContentLoaded', function() {
    video = document.getElementById('videoPlayer');
    initializePlayer();
    setupEventListeners();
    updateStats();
});

function initializePlayer() {
    const playlistUrl = `/playlist/${videoId}`;
    
    if (Hls.isSupported()) {
        hls = new Hls({
            debug: false,
            enableWorker: true,
            lowLatencyMode: false,
            backBufferLength: 90
        });
        
        hls.loadSource(playlistUrl);
        hls.attachMedia(video);
        
        hls.on(Hls.Events.MANIFEST_PARSED, function() {
            document.getElementById('playerStatus').textContent = 'Ready to play';
            console.log('HLS manifest parsed, found ' + hls.levels.length + ' quality levels');
        });
        
        hls.on(Hls.Events.ERROR, function(event, data) {
            console.error('HLS Error:', data);
            if (data.fatal) {
                switch(data.type) {
                    case Hls.ErrorTypes.NETWORK_ERROR:
                        document.getElementById('playerStatus').textContent = 'Network error';
                        break;
                    case Hls.ErrorTypes.MEDIA_ERROR:
                        document.getElementById('playerStatus').textContent = 'Media error';
                        hls.recoverMediaError();
                        break;
                    default:
                        document.getElementById('playerStatus').textContent = 'Fatal error';
                        hls.destroy();
                        break;
                }
            }
        });
        
        hls.on(Hls.Events.LEVEL_SWITCHED, function(event, data) {
            document.getElementById('videoQuality').textContent = `${hls.levels[data.level].height}p`;
        });
        
    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        // Native HLS support (Safari)
        video.src = playlistUrl;
        document.getElementById('playerStatus').textContent = 'Native HLS support';
    } else {
        document.getElementById('playerStatus').textContent = 'HLS not supported';
        alert('Your browser does not support HLS video playback.');
    }
}

function setupEventListeners() {
    video.addEventListener('loadedmetadata', function() {
        document.getElementById('videoDuration').textContent = formatTime(video.duration);
    });
    
    video.addEventListener('timeupdate', function() {
        document.getElementById('currentTime').textContent = formatTime(video.currentTime);
        updateBufferHealth();
    });
    
    video.addEventListener('play', function() {
        document.getElementById('playPauseBtn').innerHTML = 'â¸ï¸ Pause';
    });
    
    video.addEventListener('pause', function() {
        document.getElementById('playPauseBtn').innerHTML = 'â–¶ï¸ Play';
    });
    
    video.addEventListener('error', function(e) {
        console.error('Video error:', e);
        document.getElementById('playerStatus').textContent = 'Video error';
    });
}

function playPause() {
    if (video.paused) {
        video.play();
    } else {
        video.pause();
    }
}

function seekBackward() {
    video.currentTime = Math.max(0, video.currentTime - 10);
}

function seekForward() {
    video.currentTime = Math.min(video.duration, video.currentTime + 10);
}

function toggleFullscreen() {
    if (document.fullscreenElement) {
        document.exitFullscreen();
    } else {
        video.requestFullscreen();
    }
}

function setVolume(value) {
    video.volume = value;
}

function setPlaybackRate(rate) {
    video.playbackRate = parseFloat(rate);
}

function updateBufferHealth() {
    if (video.buffered.length > 0) {
        const bufferedEnd = video.buffered.end(video.buffered.length - 1);
        const currentTime = video.currentTime;
        const bufferHealth = Math.max(0, bufferedEnd - currentTime);
        document.getElementById('bufferHealth').textContent = formatTime(bufferHealth);
    }
}

function updateStats() {
    // Update network state
    const states = ['EMPTY', 'IDLE', 'LOADING', 'NO_SOURCE'];
    document.getElementById('networkState').textContent = states[video.networkState] || 'UNKNOWN';
    
    // Update dropped frames (if available)
    if (video.getVideoPlaybackQuality) {
        const quality = video.getVideoPlaybackQuality();
        document.getElementById('droppedFrames').textContent = quality.droppedVideoFrames || 0;
    }
    
    setTimeout(updateStats, 1000);
}

function reloadVideo() {
    if (hls) {
        hls.destroy();
    }
    initializePlayer();
}

async function copyPlaylistUrl() {
    const url = `${window.location.origin}/playlist/${videoId}`;
    try {
        await navigator.clipboard.writeText(url);
        showToast('Playlist URL copied to clipboard!');
    } catch (error) {
        showToast('Failed to copy URL', 'error');
    }
}

async function copyPlayerUrl() {
    try {
        await navigator.clipboard.writeText(window.location.href);
        showToast('Player URL copied to clipboard!');
    } catch (error) {
        showToast('Failed to copy URL', 'error');
    }
}

async function downloadPlaylist() {
    try {
        const response = await fetch(`/playlist/${videoId}`);
        const content = await response.text();
        
        const blob = new Blob([content], { type: 'application/vnd.apple.mpegurl' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `${videoId}.m3u8`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast('Playlist downloaded!');
    } catch (error) {
        showToast('Failed to download playlist', 'error');
    }
}

async function showPlaylistInfo() {
    try {
        const response = await fetch(`/playlist/${videoId}`);
        const content = await response.text();
        
        document.getElementById('playlistContent').value = content;
        document.getElementById('playlistModal').style.display = 'flex';
    } catch (error) {
        showToast('Failed to load playlist content', 'error');
    }
}

function closePlaylistModal() {
    document.getElementById('playlistModal').style.display = 'none';
}

async function copyPlaylistContent() {
    const content = document.getElementById('playlistContent').value;
    try {
        await navigator.clipboard.writeText(content);
        showToast('Playlist content copied to clipboard!');
    } catch (error) {
        showToast('Failed to copy content', 'error');
    }
}

function downloadPlaylistFile() {
    const content = document.getElementById('playlistContent').value;
    const blob = new Blob([content], { type: 'application/vnd.apple.mpegurl' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `${videoId}.m3u8`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast('Playlist file downloaded!');
}

async function deleteVideo() {
    if (!confirm('Are you sure you want to delete this video? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/video/${videoId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showToast('Video deleted successfully!');
            setTimeout(() => {
                window.location.href = '/videos';
            }, 2000);
        } else {
            const result = await response.json();
            showToast(`Failed to delete video: ${result.detail}`, 'error');
        }
    } catch (error) {
        showToast(`Delete error: ${error.message}`, 'error');
    }
}

function formatTime(seconds) {
    if (isNaN(seconds)) return '--:--';
    
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    
    if (hours > 0) {
        return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    } else {
        return `${minutes}:${secs.toString().padStart(2, '0')}`;
    }
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        background: ${type === 'error' ? 'var(--error-color)' : 'var(--success-color)'};
        color: white;
        border-radius: 0.375rem;
        box-shadow: var(--shadow-lg);
        z-index: 1000;
        animation: slideIn 0.3s ease;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}
</script>

<style>
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: var(--surface);
    border-radius: 0.5rem;
    max-width: 600px;
    width: 90%;
    max-height: 90%;
    overflow-y: auto;
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-body {
    padding: 1.5rem;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}
</style>
{% endblock %}
