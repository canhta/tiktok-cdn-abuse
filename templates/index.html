{% extends "base.html" %}

{% block title %}TikTok CDN Demo{% endblock %}

{% block content %}
<div class="text-center mb-8">
    <h1 class="page-title">ğŸ¬ TikTok CDN Demo</h1>
    <p class="page-subtitle">âš ï¸ Educational demonstration of CDN exploitation techniques</p>
    <div class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded mb-4">
        <strong>Demo Purpose Only:</strong> This tool demonstrates potential security vulnerabilities for educational purposes.
    </div>

    <!-- Clear Cache Button -->
    <div class="mb-4">
        <button id="clearCacheBtn" class="btn btn-secondary">
            ğŸ—‘ï¸ Clear Browser Cache
        </button>
    </div>
</div>

<!-- CDN Configuration -->
<div class="card mb-6">
    <div class="card-header">
        <h3 class="card-title">ï¿½ CDN Configuration</h3>
        <p class="card-description">Configure TikTok session cookies</p>
    </div>
    <div class="card-content">
        <form id="cookieForm">
            <div class="form-group">
                <label for="cdnCookies" class="form-label">TikTok Session Cookies</label>
                <textarea
                    id="cdnCookies"
                    name="cookies"
                    rows="2"
                    class="form-input"
                    placeholder="session_id=abc123;csrf_token=xyz789;"
                ></textarea>
                <small class="text-secondary">
                    Get from TikTok Ads Manager â†’ DevTools â†’ Network â†’ Copy cookies
                </small>
            </div>

            <div class="flex gap-2">
                <button type="submit" class="btn btn-primary flex-1">ğŸ’¾ Save Cookies</button>
                <button type="button" id="testCdn" class="btn btn-secondary">ğŸ§ª Test CDN</button>
            </div>
        </form>

        <div id="cookieStatus" class="status mt-3" style="display: none;"></div>
    </div>
</div>

<!-- Video Upload -->
<div class="card mb-6">
    <div class="card-header">
        <h3 class="card-title">ï¿½ Upload Video</h3>
        <p class="card-description">Upload and convert to HLS with CDN injection</p>
    </div>
    <div class="card-content">
        <form id="uploadForm" enctype="multipart/form-data">
            <div class="form-group">
                <label for="videoFile" class="form-label">Video File</label>
                <input type="file" id="videoFile" name="video" accept="video/*" class="form-input" required>
                <small class="text-secondary">Supported: MP4, AVI, MOV, MKV, WebM</small>
            </div>

            <div class="form-group">
                <label for="injectionRatio" class="form-label">CDN Injection Ratio</label>
                <input type="range" id="injectionRatio" name="injection_ratio" min="0" max="1" step="0.1" value="0.5" class="form-input">
                <small class="text-secondary">Ratio of fake CDN images in playlist: <span id="ratioValue">50%</span></small>
            </div>

            <button type="submit" class="btn btn-primary w-full">ğŸš€ Upload & Convert</button>
        </form>

        <div id="uploadStatus" class="status mt-3" style="display: none;"></div>
        <div id="uploadProgress" class="progress mt-3" style="display: none;">
            <div class="progress-bar" style="width: 0%"></div>
        </div>
    </div>
</div>

<!-- Video List & Player -->
<div class="card mb-6">
    <div class="card-header">
        <h3 class="card-title">ğŸï¸ Videos</h3>
        <p class="card-description">Uploaded videos with obfuscated playlists</p>
    </div>
    <div class="card-content">
        <div id="videoList">
            <div class="text-center text-secondary">Loading videos...</div>
        </div>

        <!-- Video Player -->
        <div id="videoPlayer" style="display: none;" class="mt-6">
            <h4 class="font-semibold mb-3">Video Player</h4>
            <video id="hlsPlayer" controls class="w-full max-w-2xl mx-auto bg-black rounded"></video>
            <div class="mt-3 text-sm">
                <strong>Playlist URL:</strong> <span id="playlistUrl" class="font-mono text-xs"></span>
                <button id="copyPlaylist" class="btn btn-secondary btn-sm ml-2">ğŸ“‹ Copy</button>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3 class="card-title">ğŸ“Š System Status</h3>
        <p class="card-description">Current system information</p>
    </div>
    <div class="card-content">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <h4 class="font-semibold mb-2">ğŸ“ˆ Statistics</h4>
                <div id="systemStats" class="space-y-2">
                    <div class="flex justify-between">
                        <span>Total Videos:</span>
                        <span id="totalVideos">Loading...</span>
                    </div>
                    <div class="flex justify-between">
                        <span>CDN Status:</span>
                        <span id="cdnStatus">Loading...</span>
                    </div>
                </div>
            </div>

        </div>
        <div class="mt-4">
            <button onclick="loadSystemStatus()" class="btn btn-secondary">ğŸ”„ Refresh Status</button>
        </div>
    </div>
</div>


{% endblock %}

{% block scripts %}
<script src="/static/libs/hls.min.js"></script>
<script>
// Browser cache management
function clearBrowserCache() {
    localStorage.clear();
    sessionStorage.clear();
    if ('caches' in window) {
        caches.keys().then(names => {
            names.forEach(name => caches.delete(name));
        });
    }
    showStatus(document.getElementById('cookieStatus'), 'success', 'âœ… Browser cache cleared');
    location.reload();
}

// Cookie form is now handled by shared.js

// CDN test
document.getElementById('testCdn').addEventListener('click', async () => {
    const status = document.getElementById('cookieStatus');
    showStatus(status, 'info', 'Testing CDN access...');

    try {
        const formData = new FormData();
        formData.append('count', '1');

        const response = await fetch('/upload-fake-images', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.uploaded > 0) {
            showStatus(status, 'success', 'âœ… CDN test successful');
        } else {
            showStatus(status, 'error', 'âŒ CDN test failed - check cookies');
        }
    } catch (error) {
        showStatus(status, 'error', `âŒ CDN test error: ${error.message}`);
    }
});

// Upload form handler
document.getElementById('uploadForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData();
    const videoFile = document.getElementById('videoFile').files[0];
    const injectionRatio = document.getElementById('injectionRatio').value;

    if (!videoFile) {
        showStatus(document.getElementById('uploadStatus'), 'error', 'âŒ Please select a video file');
        return;
    }

    formData.append('video', videoFile);
    formData.append('injection_ratio', injectionRatio);

    const status = document.getElementById('uploadStatus');
    const progress = document.getElementById('uploadProgress');

    showStatus(status, 'info', 'Uploading and converting video...');
    progress.style.display = 'block';

    try {
        const response = await fetch('/upload', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.video_id) {
            showStatus(status, 'success', `âœ… Video uploaded: ${result.video_id}`);

            // Cache video info
            const videos = JSON.parse(localStorage.getItem('uploaded_videos') || '[]');
            videos.unshift({
                video_id: result.video_id,
                playlist_url: result.playlist_url,
                segments: result.segments,
                injection_ratio: result.injection_ratio,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('uploaded_videos', JSON.stringify(videos.slice(0, 10))); // Keep last 10

            loadVideoList();
        } else {
            showStatus(status, 'error', 'âŒ Upload failed');
        }
    } catch (error) {
        showStatus(status, 'error', `âŒ Upload error: ${error.message}`);
    } finally {
        progress.style.display = 'none';
    }
});

// Injection ratio slider
document.getElementById('injectionRatio').addEventListener('input', (e) => {
    document.getElementById('ratioValue').textContent = Math.round(e.target.value * 100) + '%';
});

// Clear cache button
document.getElementById('clearCacheBtn').addEventListener('click', clearBrowserCache);

// Video list loading is now handled by shared.js

// Play video
async function playVideo(videoId) {
    try {
        const playlistUrl = `/playlist/${videoId}`;
        const player = document.getElementById('hlsPlayer');
        const playerDiv = document.getElementById('videoPlayer');

        if (Hls.isSupported()) {
            const hls = new Hls();
            hls.loadSource(playlistUrl);
            hls.attachMedia(player);
        } else if (player.canPlayType('application/vnd.apple.mpegurl')) {
            player.src = playlistUrl;
        }

        document.getElementById('playlistUrl').textContent = playlistUrl;
        playerDiv.style.display = 'block';

        // Scroll to player
        playerDiv.scrollIntoView({ behavior: 'smooth' });

    } catch (error) {
        console.error('Failed to play video:', error);
    }
}

// Delete video function is now handled by shared.js

// Copy playlist URL
document.getElementById('copyPlaylist').addEventListener('click', () => {
    const url = document.getElementById('playlistUrl').textContent;
    navigator.clipboard.writeText(url);
    showStatus(document.getElementById('cookieStatus'), 'success', 'ğŸ“‹ Playlist URL copied');
});

// Status display and system status functions are now handled by shared.js

// Initialization is now handled by shared.js
</script>
{% endblock %}
