{% extends "base.html" %}

{% block title %}Admin Panel - Video Hosting CDN{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="page-title">‚öôÔ∏è Admin Panel</h1>
    <p class="page-subtitle">Manage CDN uploads, system configuration, and monitoring</p>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- CDN Configuration -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">üîë CDN Configuration</h3>
            <p class="card-description">Configure TikTok CDN session cookies</p>
        </div>
        <div class="card-content">
            <form id="cookieForm">
                <div class="form-group">
                    <label for="cdnCookies" class="form-label">TikTok Session Cookies</label>
                    <textarea
                        id="cdnCookies"
                        name="cookies"
                        rows="3"
                        class="form-input"
                        placeholder="session_id=abc123;csrf_token=xyz789;other_cookie=value;"
                    ></textarea>
                    <small class="text-secondary">
                        Get cookies from TikTok Ads Manager ‚Üí DevTools ‚Üí Network ‚Üí Copy cookies
                    </small>
                </div>

                <div class="flex gap-2">
                    <button type="submit" class="btn btn-primary flex-1">
                        üíæ Save Cookies
                    </button>
                    <button type="button" id="clearCookies" class="btn btn-secondary">
                        üóëÔ∏è Clear
                    </button>
                </div>
            </form>

            <div id="cookieStatus" class="status mt-3" style="display: none;"></div>
        </div>
    </div>

    <!-- CDN Test -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">üß™ CDN Test</h3>
            <p class="card-description">Test uploading fake images to TikTok CDN</p>
        </div>
        <div class="card-content">
            <form id="cdnForm">
                <div class="form-group">
                    <label for="imageCount" class="form-label">Test Images</label>
                    <input type="number" id="imageCount" name="count" value="5" min="1" max="10" class="form-input">
                    <small class="text-secondary">Upload 1x1 PNG images to test CDN access</small>
                </div>

                <button type="submit" class="btn btn-primary w-full">
                    üß™ Test CDN Upload
                </button>
            </form>

            <div id="cdnStatus" class="status" style="display: none;"></div>
        </div>
    </div>

    <!-- System Status -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">üìä System Status</h3>
            <p class="card-description">Current system information and statistics</p>
        </div>
        <div class="card-content">
            <div class="space-y-3">
                <div class="flex justify-between">
                    <span>CDN Configured:</span>
                    <span id="cdnConfigured" class="font-semibold">Loading...</span>
                </div>
                <div class="flex justify-between">
                    <span>Cookie Source:</span>
                    <span id="cookieSource" class="font-semibold">Loading...</span>
                </div>
                <div class="flex justify-between">
                    <span>Total Videos:</span>
                    <span id="totalVideos" class="font-semibold">Loading...</span>
                </div>
                <div class="flex justify-between">
                    <span>Storage Used:</span>
                    <span id="storageUsed" class="font-semibold">Loading...</span>
                </div>
            </div>
            
            <div class="mt-4">
                <button onclick="refreshStatus()" class="btn btn-secondary w-full">
                    üîÑ Refresh Status
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Configuration -->
<div class="card mt-6">
    <div class="card-header">
        <h3 class="card-title">üîß Configuration</h3>
        <p class="card-description">CDN and system configuration settings</p>
    </div>
    <div class="card-content">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <h4 class="font-semibold mb-3">CDN Settings</h4>
                <div class="space-y-3 text-sm">
                    <div>
                        <strong>Session Status:</strong><br>
                        <span id="sessionStatus">Checking...</span>
                    </div>
                </div>
            </div>
            
            <div>
                <h4 class="font-semibold mb-3">System Settings</h4>
                <div class="space-y-3 text-sm">
                    <div>
                        <strong>Max File Size:</strong><br>
                        500 MB per video
                    </div>
                    <div>
                        <strong>Supported Formats:</strong><br>
                        MP4, AVI, MOV, MKV, WebM
                    </div>
                    <div>
                        <strong>Segment Duration:</strong><br>
                        10 seconds (configurable)
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block scripts %}
<script>
async function refreshStatus() {
    try {
        // Load CDN status
        const cdnResponse = await fetch('/cdn-status');
        const cdnData = await cdnResponse.json();
        
        document.getElementById('cdnConfigured').textContent = cdnData.cdn_configured ? '‚úÖ Yes' : '‚ùå No';
        document.getElementById('cookieSource').textContent = cdnData.cookies_source === 'dynamic' ? 'üîÑ Dynamic' : '‚öôÔ∏è Config';
        document.getElementById('sessionStatus').textContent = cdnData.cdn_configured ? '‚úÖ Active' : '‚ùå Not configured';
        
        // Load video count
        const videosResponse = await fetch('/videos');
        const videosData = await videosResponse.json();
        document.getElementById('totalVideos').textContent = videosData.videos ? videosData.videos.length : '0';
        
        // Estimate storage (simplified)
        const videoCount = videosData.videos ? videosData.videos.length : 0;
        const estimatedStorage = videoCount * 50; // Rough estimate: 50MB per video
        document.getElementById('storageUsed').textContent = `~${estimatedStorage} MB`;
        
    } catch (error) {
        console.error('Failed to refresh status:', error);
        const statusElement = document.getElementById('cookieStatus');
        if (statusElement) {
            showStatus(statusElement, 'error', 'Failed to refresh status');
        }
    }
}







async function loadRecentActivity() {
    try {
        const response = await fetch('/videos');
        const data = await response.json();
        const recentActivity = document.getElementById('recentActivity');
        
        if (data.videos && data.videos.length > 0) {
            const recent = data.videos.slice(0, 5); // Show last 5 videos
            recentActivity.innerHTML = recent.map(video => `
                <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-b-0">
                    <div>
                        <div class="font-medium">${video.video_id}</div>
                        <div class="text-sm text-secondary">Video uploaded</div>
                    </div>
                    <div class="text-sm text-secondary">
                        <a href="/player/${video.video_id}" class="text-primary">View</a>
                    </div>
                </div>
            `).join('');
        } else {
            recentActivity.innerHTML = '<div class="text-center text-secondary">No recent activity</div>';
        }
    } catch (error) {
        console.error('Failed to load recent activity:', error);
        recentActivity.innerHTML = '<div class="text-center text-error">Failed to load activity</div>';
    }
}

// showStatus function is now handled by shared.js

// Cookie management is now handled by shared.js

// Clear cookies button
document.getElementById('clearCookies').addEventListener('click', () => {
    document.getElementById('cdnCookies').value = '';
    localStorage.removeItem('tiktok_cdn_cookies');

    // Update server
    const formData = new FormData();
    formData.append('cookies', '');
    fetch('/update-cdn-cookies', { method: 'POST', body: formData });

    const cookieStatus = document.getElementById('cookieStatus');
    showStatus(cookieStatus, 'success', '‚úÖ Cookies cleared');

    setTimeout(refreshStatus, 1000);
});

// loadSavedCookies function is now handled by shared.js

// CDN Form Handler
document.getElementById('cdnForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const cdnStatus = document.getElementById('cdnStatus');
    const count = document.getElementById('imageCount').value;

    showStatus(cdnStatus, 'info', 'Uploading fake images to CDN...');

    try {
        const formData = new FormData();
        formData.append('count', count);

        const response = await fetch('/upload-fake-images', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.uploaded > 0) {
            showStatus(cdnStatus, 'success', `‚úÖ CDN test successful: ${result.uploaded}/${result.total_requested} images uploaded`);
            setTimeout(refreshStatus, 1000);
        } else {
            showStatus(cdnStatus, 'error', `‚ùå CDN test failed: No images uploaded`);
        }
    } catch (error) {
        showStatus(cdnStatus, 'error', `‚ùå Error: ${error.message}`);
    }
});

// Page initialization - add admin-specific functionality
document.addEventListener('DOMContentLoaded', () => {
    // Shared initialization is handled by shared.js
    refreshStatus(); // Admin-specific status refresh
});
</script>
{% endblock %}
